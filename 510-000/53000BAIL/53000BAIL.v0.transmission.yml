# yaml-language-server: $schema=https://formulaires.it.mtess.gouv.qc.ca/api/v1/SIS/ObtenirSchema/transmission

workflows:
  - id: bail53000
    # Rôles du WF
    roles:
      - id: locateurPrincipal
        label: 
          fr: "Locateur principal"
      - id: locateur
        label: 
          fr: "Autre locateur"
      - id: locataire
        label: 
          fr: "Locataire"
      - id: autreSignataire
        label: 
          fr: "Autre signataire"
      - id: mandant
        label: 
          fr: "Mandant"

    # Étapes du WF
    etapes:
      # Étape initiale (le locateur principal rempli le form)
      #=================================================================
      # === Quand terminé (le locateur principal a transmis le form) ===
      #=================================================================
      # On passe à l'étape contributionSignature pour les rôles locataire, autre locateur et autreSignataire
      # On passe à l'étape transmission pour le rôle locateurPrincipal
      #
      #=================================================================
      # === Courriels envoyés ===
      #=================================================================
      # - Aux locataires, autres locateurs et aux autres signataires pour contribution et signature.
      # - Au locateur principal pour lui indiquer qu'il peut suivre l'avancement du processus de signature.

      - id: initial
        label: 
          fr: Initial
          en: Initial      
        evenements:
          quandQuelqunTransmet:
            - tache: genererPdf
              langue: langueBail
            - tache: interventionParticipant
              langue: fr
              options: 
                  role: locataire
                  vers: contributionSignature
                  chargerCourrielsWorkflow: true   
                  modeBoutonTesterTransmission: simuler
            - tache: interventionParticipant
              langue: fr
              options: 
                  role: locateur
                  vers: contributionSignature
                  chargerCourrielsWorkflow: true   
                  modeBoutonTesterTransmission: simuler
            - tache: interventionParticipant
              langue: fr
              options: 
                  role: autreSignataire
                  vers: contributionSignature
                  chargerCourrielsWorkflow: true   
                  modeBoutonTesterTransmission: simuler
            - tache: interventionParticipant
              langue: fr
              options: 
                  role: locateurPrincipal
                  # vers: transmission
                  chargerCourrielsWorkflow: true
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.  

            - tache: interventionParticipant
              langue: fr
              options: 
                  role: mandant
                  chargerCourrielsWorkflow: true
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.  

            - tache: envoyerCourrielParticipant
              langue: fr
              options: 
                  role: locataire
                  gabarit: demandeContributionSignature
            - tache: envoyerCourrielParticipant
              langue: fr
              options: 
                  role: locateur
                  gabarit: demandeContributionSignature
            - tache: envoyerCourrielParticipant
              langue: fr
              options: 
                  role: autreSignataire
                  gabarit: demandeContributionSignature
            - tache: envoyerCourrielParticipant
              langue: fr
              options: 
                  role: locateurPrincipal
                  gabarit: suiviBail
                  modeBoutonTesterTransmission: simuler
                  
      - id: contributionSignature
        label: 
          fr: Contribution et signature
          en: TODO english Contribution et signature
        evenements:
          quandLeDernierTransmet:
            - tache: interventionParticipant
              langue: fr
              options: 
                  role: locateurPrincipal
                  vers: transmission
                  chargerCourrielsWorkflow: true
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.  

            - tache: envoyerCourrielParticipant
              langue: fr
              options: 
                  role: locateurPrincipal
                  gabarit: demandeTransmission
                  modeBoutonTesterTransmission: simuler
                  #conditionsEt:
                  #  - condition: '=='

      - id: transmission
        label: 
          fr: Transmission
          en: TODO english Transmission
        evenements:
          quandQuelqunTransmet:
            - tache: genererPdf
              langue: langueBail
            - tache: traiterDocumentsSoumis
              langue: fr
            - tache: ajouterEstampille
              langue: fr
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              langue: fr
              options: 
                  role: locateurPrincipal
                  gabarit: confirmationBailFinal
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              langue: fr
              options: 
                  role: locateur
                  gabarit: confirmationBailFinal
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              langue: fr
              options: 
                  role: locataire
                  gabarit: confirmationBailFinal
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.                     
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              langue: fr
              options: 
                  role: autreSignataire
                  gabarit: confirmationBailFinal
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.                     
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              langue: fr
              options: 
                  role: mandant
                  gabarit: confirmationBailFinal
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.                     


gabaritsCourriels:
  - id: demandeContributionSignature
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: TAL
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Formulaire de bail électronique à compléter et signer
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
      <p>Bonjour,</p>
      <p>Ce courriel concerne le logement situé au : <b>{{donneesFormulaire.form.adresseLogement.0.adresseComplete}}</b></p>      
      <p>Vous êtes invité à valider les informations saisies par le locateur et à remplir les sections du formulaire de bail qui vous concernent.</p>
      <p>Si vous avez des questions, si vous constatez des erreurs ou que des modifications doivent être apportées au formulaire de bail, veuillez communiquer directement avec le locateur (p. ex : téléphone, message texte, courriel, etc.). Il sera en mesure d’effectuer les modifications nécessaires et un nouveau formulaire de bail vous sera transmis, le cas échéant.</p>
      <p><b>Pour y accéder, veuillez cliquer sur l’hyperlien ci-dessous :</b><br/>
        <a href='{{envoyerCourriel.participantCourant.lienReprise}}'>Compléter et signer le bail de logement</a>
      </p>
      <p>Un <b>mot de passe est nécessaire</b> pour y accéder. Si le locateur ne vous l’a pas fourni, nous vous invitons à communiquer avec lui.</p>
      <p>Veuillez noter que l’hyperlien pour <b>signer et finaliser</b> le formulaire de bail électronique est valide pour <strong>36 heures</strong> à compter de sa transmission aux autres parties. Une fois ce délai écoulé, il ne sera plus accessible.</p>
      <br><br>
      <p><i>Veuillez ne pas répondre à ce message, car il a été envoyé automatiquement.</i><p>

  - id: suiviBail
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: TAL
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Suivi de l’évolution de votre formulaire de bail électronique
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |          
      <p>Bonjour,</p>
      <p>Ce courriel concerne le logement situé au : <b>{{donneesFormulaire.form.adresseLogement.0.adresseComplete}}</b></p>      
      <p>Nous vous confirmons que votre formulaire de bail électronique a été transmis aux autres parties afin qu’elles en prennent connaissance et le signent.</p> 
      <p>Vous pourrez vérifier en tout temps si les autres parties ont complété les sections qui les concernent et signé le formulaire en cliquant sur l’hyperlien ci-dessous :<br/>
        <a href='{{envoyerCourriel.participantCourant.lienReprise}}'>Suivre l'avancement du processus de signature du bail de logement</a>
      </p>
      <p><b>Un avis sera transmis à votre adresse de courriel lorsque toutes les parties auront rempli et signé le formulaire.</b></p>
      <p>Veuillez noter que l’hyperlien pour <b>signer et finaliser</b> le formulaire de bail électronique est valide pour <strong>36 heures</strong> à compter de sa transmission aux autres parties. Une fois ce délai écoulé, il ne sera plus accessible et vous devrez le remplir à nouveau.</p>
      <br><br>
      <p><i>Veuillez ne pas répondre à ce message, car il a été envoyé automatiquement.</i><p>
        
  - id: demandeTransmission
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: TAL
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Signature du formulaire de bail électronique
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
      <p>Bonjour,</p>
      <p>Ce courriel concerne le logement situé au : <b>{{donneesFormulaire.form.adresseLogement.0.adresseComplete}}</b></p>      
      <p>Nous vous confirmons que les autres parties ont rempli et signé le formulaire de bail électronique.</p>
      <p>Pour le signer à votre tour et conclure le contrat de bail, vous pouvez cliquer sur l’hyperlien ci-dessous :<br/>
        <a href='{{envoyerCourriel.participantCourant.lienReprise}}'>Vérifier et signer le bail de logement</a>
      </p>
      <p><b>Veuillez noter que l’hyperlien pour signer et finaliser le formulaire de bail électronique est valide pour 36 heures</b>. Une fois ce délai écoulé, il ne sera plus accessible et vous devrez le remplir à nouveau.</p>
      <br><br>
      <p><i>Veuillez ne pas répondre à ce message, car il a été envoyé automatiquement.</i><p>

  - id: confirmationBailFinal
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: TAL
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Formulaire de bail électronique final
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
      <p>Bonjour,</p>
      <p>Ce courriel concerne le logement situé au : <b>{{donneesFormulaire.form.adresseLogement.0.adresseComplete}}</b></p>            
      <p><b>Le formulaire de bail électronique est maintenant complété et final</b>. Il est joint au présent courriel ainsi que tous les documents qui l’accompagnent, le cas échéant.</p>
      <p>Ces documents seront disponibles pour téléchargement ou impression pendant <b>90 jours. Une fois ce délai expiré, les documents ne seront plus disponibles</b>.</p>
      <p>Veuillez en conserver une copie en lieu sûr pour référence future.</p>
      <p><b>Veuillez trouver ci-dessous le(s) document(s) :</b></p>
      <ul>
        {{#listePJ}}
      <li><a href="{{url}}">{{nomOriginal}}</a></li>
        {{/listePJ}}
      </ul>    
      <br><br>
      <p><i>Veuillez ne pas répondre à ce message, car il a été envoyé automatiquement.</i><p>
