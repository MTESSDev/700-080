# yaml-language-server: $schema=https://formulaires.it.mtess.gouv.qc.ca/api/v1/SIS/ObtenirSchema/transmission

workflows:
  - id: bail53000
    # Rôles du WF
    roles:
      - id: locateurPrincipal
        label: 
          fr: "Locateur principal"
      - id: locateur
        label: 
          fr: "Autre locateur"
      - id: locataire
        label: 
          fr: "Locataire"
      - id: autreSignataire
        label: 
          fr: "Autre signataire"

    # Étapes du WF
    etapes:
      # Étape initiale (le locateur principal rempli le form)
      #=================================================================
      # === Quand terminé (le locateur principal a transmis le form) ===
      #=================================================================
      # On passe à l'étape contributionSignature pour les rôles locataire, autre locateur et autreSignataire
      # On passe à l'étape transmission pour le rôle locateurPrincipal
      #
      #=================================================================
      # === Courriels envoyés ===
      #=================================================================
      # - Aux locataires, autres locateurs et aux autres signataires pour contribution et signature.
      # - Au locateur principal pour lui indiquer qu'il peut suivre l'avancement du processus de signature.

      - id: initial
        label: 
          fr: Initial
          en: Initial      
        evenements:
          quandQuelqunTransmet:
            - tache: interventionParticipant
              options: 
                  role: locataire
                  vers: contributionSignature
                  chargerCourrielsWorkflow: true   
                  modeBoutonTesterTransmission: simuler
            - tache: interventionParticipant
              options: 
                  role: locateur
                  vers: contributionSignature
                  chargerCourrielsWorkflow: true   
                  modeBoutonTesterTransmission: simuler
            - tache: interventionParticipant
              options: 
                  role: autreSignataire
                  vers: contributionSignature
                  chargerCourrielsWorkflow: true   
                  modeBoutonTesterTransmission: simuler
            - tache: interventionParticipant
              options: 
                  role: locateurPrincipal
                  vers: transmission
                  chargerCourrielsWorkflow: true
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.  

            - tache: envoyerCourrielParticipant
              options: 
                  role: locataire
                  gabarit: demandeContributionSignature
            - tache: envoyerCourrielParticipant
              options: 
                  role: locateur
                  gabarit: demandeContributionSignature
            - tache: envoyerCourrielParticipant
              options: 
                  role: autreSignataire
                  gabarit: demandeContributionSignature
            - tache: envoyerCourrielParticipant
              options: 
                  role: locateurPrincipal
                  gabarit: suiviBail
                  modeBoutonTesterTransmission: simuler
                  
      - id: contributionSignature
        label: 
          fr: Contribution et signature
          en: TODO english Contribution et signature
        evenements:
          quandLeDernierTransmet:
            - tache: envoyerCourrielParticipant
              options: 
                  role: locateurPrincipal
                  gabarit: demandeTransmission
                  modeBoutonTesterTransmission: simuler
                  #conditionsEt:
                  #  - condition: '=='

      - id: transmission
        label: 
          fr: Transmission
          en: TODO english Transmission
        evenements:
          quandQuelqunTransmet:
            - tache: genererPDF
            - tache: traiterDocumentsSoumis
            - tache: ajouterEstampille
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              options: 
                  role: locateurPrincipal
                  gabarit: confirmationBailLocateur
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.
                  filtresDocuments:
                    - typeFiltre: tacheSource
                      valeurs: genererPDF     
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              options: 
                  role: locateur
                  gabarit: confirmationBailLocateur
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.
                  filtresDocuments:
                    - typeFiltre: tacheSource
                      valeurs: genererPDF   
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              options: 
                  role: locataire
                  gabarit: confirmationBailLocataire
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.
                  filtresDocuments:
                    - typeFiltre: tacheSource
                      valeurs: genererPDF                          
            - tache: envoyerCourrielParticipant # remplacer par un envoyerCourrielParticipant pour chaque rôle
              options: 
                  role: autreSignataire
                  gabarit: confirmationBailLocataire
                  modeBoutonTesterTransmission: simuler #ignorer tâche skippée au complet #simuler ça fait comme si mais ça le fait pas mais ça le montre # pas d'option = execute pour vrai.
                  filtresDocuments:
                    - typeFiltre: tacheSource
                      valeurs: genererPDF                          


gabaritsCourriels:
  - id: demandeContributionSignature
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: Un gentil locateur
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Veuillez réviser et compléter votre bail de logement
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
      <p>Bonjour,</p>
      <p>Un locateur a démarré un processus de signature de bail dans lequel vous êtes impliqué et devez intervenir.</p>
      <p><b>Logement concerné :</b><br/>
      {{donneesFormulaire.form.adresseLogement.0.adresseComplete}}
      </p>
      <p><b>Intervention requise :</b><br/>
      Veuillez cliquer sur le lien ci-dessous pour accéder au formulaire de bail électronique, compléter les informations requise et le signer :</br>
      <a href='{{envoyerCourriel.participantCourant.lienReprise}}'>Accéder au formulaire de bail</a>
      </p>      
      <p><b>Important :</b></br>
      Un délai maximal de 36 heures est aloué pour le processus de signature. Passé ce délai, le lien sera expiré et il faudra recommencer le processus.</p>
      <br/>
      <p>Ce message est automatisé. Nous vous demandons de ne pas y répondre.</p>
      <div style="margin-top:48px">Ici insérer la signature du TAL?</div>

  - id: suiviBail
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: De nouveaux locataires
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Suivre l'avancement du processus de signature de votre bail de logement.
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |          
      <p>Bonjour,</p>
      <p>Nous vous confirmons que le processus de signature électronique de votre bail est maintenant démarré.</p>
      <p><b>Logement concerné :</b><br/>
      {{donneesFormulaire.form.adresseLogement.0.adresseComplete}}
      </p>
      <p><b>Intervention requise :</b><br/>
      Veuillez cliquer sur le lien ci-dessous pour accéder au formulaire de bail électronique et suivre l'avancement du processus :</br>
      <a href='{{envoyerCourriel.participantCourant.lienReprise}}'>Suivre l'avancement du processus de signature du bail de logement</a>
      </p>      
      <p><b>Important :</b></br>
      Un délai maximal de 36 heures est aloué pour le processus de signature. Passé ce délai, le lien sera expiré et il faudra recommencer le processus.</p>
      <br/>
      <p>Ce message est automatisé. Nous vous demandons de ne pas y répondre.</p>
      <div style="margin-top:48px">Ici insérer la signature du TAL?</div>
        
  - id: demandeTransmission
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: Transmission
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Signer et officialiser le bail de logement.
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
      <p>Bonjour,</p>
      <p>Nous vous confirmons que le processus de signature électronique de votre bail a été complété par tous les participants.</p>
      <p><b>Logement concerné :</b><br/>
      {{donneesFormulaire.form.adresseLogement.0.adresseComplete}}
      </p>
      <p><b>Intervention requise :</b><br/>
      Veuillez cliquer sur le lien ci-dessous pour accéder au formulaire de bail électronique, le signer, payer et le transmettre :</br>
      <a href='{{envoyerCourriel.participantCourant.lienReprise}}'>Terminer le processus de signature du bail</a>
      </p>      
      <p><b>Important :</b></br>
      Un délai maximal de 36 heures est aloué pour le processus de signature. Passé ce délai, le lien sera expiré et il faudra recommencer le processus.</p>
      <br/>
      <p>Ce message est automatisé. Nous vous demandons de ne pas y répondre.</p>
      <div style="margin-top:48px">Ici insérer la signature du TAL?</div>

  - id: confirmationBailLocateur
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: Confirmation de transmission
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Votre bail complété (locateur)
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
        Bonjour, <br> Voici une copie du bail complété pour les locateurs.
        <ul>
          {{#listePJ}}
        <li><a href="{{url}}">{{nomOriginal}}</a></li>
          {{/listePJ}}
        </ul>    
  - id: confirmationBailLocataire
    # Liste des destinataires (peut être une liste)
    #a:
    #  tous: 
    #    - '{{participantCourrant.courriel}}'
    # Nom de l'expéditeur (Par défaut, "Formulaires en ligne" ou "Online forms" selon la langue)
    nomExpediteur: Confirmation de transmission
    # Permet de spécifier l'adresse de retour
    # L'objet du courriel peut contenir des parties variables
    objet: Votre bail complété (locataires)
    # Les données du formulaires peuvent être réutilisées dans le contenu du courriel
    corps: |
        Bonjour, <br> Voici une copie du bail complété pour les locataires.
        <ul>
          {{#listePJ}}
        <li><a href="{{url}}">{{nomOriginal}}</a></li>
          {{/listePJ}}
        </ul>    